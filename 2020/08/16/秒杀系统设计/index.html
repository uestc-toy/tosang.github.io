<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.0"><link rel="apple-touch-icon" sizes="180x180" href="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/avatar.png"><link rel="icon" type="image/png" sizes="32x32" href="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/avatar.png"><link rel="icon" type="image/png" sizes="16x16" href="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/avatar.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="baidu-site-verification" content="EtrqTppKP2zrDi7r"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"uestc-toy.github.io",root:"/",scheme:"Gemini",version:"7.8.0",exturl:!0,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!0,scrollpercent:!0},bookmark:{enable:!0,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!0,pangu:!1,comments:{style:"tabs",active:"valine",storage:!0,lazyload:!1,nav:null,activeClass:"valine"},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="项目构成"><meta property="og:type" content="article"><meta property="og:title" content="秒杀系统设计"><meta property="og:url" content="http://uestc-toy.github.io/2020/08/16/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/index.html"><meta property="og:site_name" content="小yi的blog"><meta property="og:description" content="项目构成"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200816092422127.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200816093027664.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200816093308985.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200817103045731.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200818094613465.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200830164436645.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200830173253365.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200830185827384.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200830192231754.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200830195357668.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200830200530077.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200831094237735.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200831094545441.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200831094721186.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200831155239617.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200831163428783.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200831170225387.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200831201908370.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200831202350866.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200831202800407.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200831203415321.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200831203721509.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200901155025174.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200901162430901.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200901162647326.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200901211222409.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200901212647586.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200902173312029.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200902173507164.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200902175227355.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200902175419543.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200902180016713.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200902180558228.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200902205723205.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903100238028.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903100756596.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903101054624.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903101337847.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903103842078.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903104638201.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903104818774.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903110933494.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903155243655.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903155315817.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903171306189.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903180924669.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903181450189.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903214017836.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200904112701538.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200904162454219.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200904163627831.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200904170053689.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200904171428254.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200905101814367.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200905104343819.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200905112151722.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200909112655053.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200909112850039.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200909163050744.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200909163649212.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200909201407037.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200909210603922.png"><meta property="article:published_time" content="2020-08-16T01:06:36.000Z"><meta property="article:modified_time" content="2020-09-11T13:55:14.351Z"><meta property="article:author" content="tosang"><meta property="article:tag" content="Java"><meta property="article:tag" content="秒杀"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200816092422127.png"><link rel="canonical" href="http://uestc-toy.github.io/2020/08/16/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1/needsharebutton.min.css"><style>#needsharebutton-postbottom{cursor:pointer;height:26px;margin-top:10px;position:relative}#needsharebutton-postbottom .btn{border:1px solid $btn-default-border-color;border-radius:3px;display:initial;padding:1px 4px}</style><style>#needsharebutton-float{bottom:88px;cursor:pointer;left:-8px;position:fixed;z-index:9999}#needsharebutton-float .btn{border:1px solid $btn-default-border-color;border-radius:4px;padding:0 10px 0 14px}</style><title>秒杀系统设计 | 小yi的blog</title><script data-pjax>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?063295f670f17958c713a81e3a2d6844";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">小yi的blog</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">从前很忙</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">10</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">7</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">13</span></a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="reading-progress-bar"></div><a role="button" class="book-mark-link book-mark-link-fixed"></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://uestc-toy.github.io/2020/08/16/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/avatar.png"><meta itemprop="name" content="tosang"><meta itemprop="description" content="blog、记录和分享"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="小yi的blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">秒杀系统设计</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-08-16 09:06:36" itemprop="dateCreated datePublished" datetime="2020-08-16T09:06:36+08:00">2020-08-16</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2020-09-11 21:55:14" itemprop="dateModified" datetime="2020-09-11T21:55:14+08:00">2020-09-11</time> </span><span id="/2020/08/16/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" class="post-meta-item leancloud_visitors" data-flag-title="秒杀系统设计" title="阅读次数"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/2020/08/16/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2020/08/16/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>27k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>25 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="项目构成"><a href="#项目构成" class="headerlink" title="项目构成"></a>项目构成</h2><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200816092422127.png" alt="分层设计" style="zoom:67%"><a id="more"></a><p>三层模型</p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200816093027664.png" alt="三层模型" style="zoom:80%"><p>UML图</p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200816093308985.png" alt="UML图" style="zoom:50%"><h2 id="秒杀项目搭建"><a href="#秒杀项目搭建" class="headerlink" title="秒杀项目搭建"></a>秒杀项目搭建</h2><p>目标：</p><ul><li>使用IDEA + Maven搭建SpringBoot开发环境</li><li>集成MyBatis操作数据库</li><li>实现秒杀项目</li></ul><h4 id="创建数据库表结构"><a href="#创建数据库表结构" class="headerlink" title="创建数据库表结构"></a>创建数据库表结构</h4><blockquote><p>user_info表，注意下面字段不包含用户密码，企业中一般密码是单独的表</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for user_info</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`user_info`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user_info`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">COLLATE</span> utf8_unicode_ci <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  <span class="string">`gender`</span> <span class="built_in">tinyint</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'1代表男性，2代表女性'</span>,</span><br><span class="line">  <span class="string">`age`</span> <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span>,</span><br><span class="line">  <span class="string">`telphone`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_unicode_ci <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`register_mode`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_unicode_ci <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'注册方式：手机号、微信、支付宝'</span>,</span><br><span class="line">  <span class="string">`third_party_id`</span> <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">COLLATE</span> utf8_unicode_ci <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COLLATE</span>=utf8_unicode_ci;</span><br></pre></td></tr></table></figure><blockquote><p>user_password表，关联user_info主键</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for user_password</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`user_password`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user_password`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`encrpt_password`</span> <span class="built_in">varchar</span>(<span class="number">128</span>) <span class="keyword">COLLATE</span> utf8_unicode_ci <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COLLATE</span>=utf8_unicode_ci;</span><br></pre></td></tr></table></figure><blockquote><p>使用mybatis-genrator自动生产相关Object和mapper映射接口，xml映射文件</p></blockquote><h4 id="领域对象模型"><a href="#领域对象模型" class="headerlink" title="领域对象模型"></a>领域对象模型</h4><p>即在service创建用户model，UserServiceImpl返回的是用户model对象。</p><p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200817103045731.png" alt="服务层"></p><h4 id="异常处理机制"><a href="#异常处理机制" class="headerlink" title="异常处理机制"></a>异常处理机制</h4><blockquote><p>创建异常接口、异常枚举类、Exception继承类（用于抛出异常）</p></blockquote><ul><li><strong>设计模式：包装器业务异常类实现</strong></li></ul><p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200818094613465.png" alt="错误处理"></p><blockquote><p>在控制层UserController抛出异常（继承BaseController）</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(EmBusinessError.USER_NOT_EXIST);</span><br></pre></td></tr></table></figure><blockquote><p>在基类控制层BaseController拦截异常，并返回CommonReturnType</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@ExceptionHandler</span>(Exception<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    @<span class="title">ResponseStatus</span>(<span class="title">HttpStatus</span>.<span class="title">OK</span>)</span></span><br><span class="line"><span class="class">    @<span class="title">ResponseBody</span></span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">Object</span> <span class="title">handlerException</span>(<span class="title">HttpServletRequest</span> <span class="title">request</span>, <span class="title">Exception</span> <span class="title">ex</span>) </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; responseData = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> BusinessException) &#123;</span><br><span class="line">            <span class="comment">//强转为BusinessException</span></span><br><span class="line">            BusinessException businessException = (BusinessException) ex;</span><br><span class="line"></span><br><span class="line">            responseData.put(<span class="string">"errCode"</span>, businessException.getErrCode());</span><br><span class="line">            responseData.put(<span class="string">"errMsg"</span>, businessException.getErrMsg());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            responseData.put(<span class="string">"errCode"</span>, EmBusinessError.UNKONWN_ERROR.getErrCode());</span><br><span class="line">            responseData.put(<span class="string">"errMsg"</span>, EmBusinessError.UNKONWN_ERROR.getErrMsg());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> CommonReturnType.create(responseData, <span class="string">"fail"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="用户信息管理"><a href="#用户信息管理" class="headerlink" title="用户信息管理"></a>用户信息管理</h4><p>◆otp短信获取<br>◆otp注册用户<br>◆用户手机登陆</p><blockquote><p>短信获取—控制层</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用户获取otp短信接口</span></span><br><span class="line"><span class="comment">//post方式，consumes为application/x-www-form-urlencoded</span></span><br><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/getotp"</span>, consumes = CONTENT_TYPE_FORMED)</span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CommonReturnType <span class="title">getOtp</span><span class="params">(@RequestParam(<span class="string">"telphone"</span>)</span>String telphone)</span>&#123;</span><br><span class="line">    <span class="comment">//需要参照一定的规则生成OTP验证码</span></span><br><span class="line">    Random random = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">int</span> randomInt = random.nextInt(<span class="number">99999</span>);<span class="comment">//随机数范围[0-99999）</span></span><br><span class="line">    randomInt +=<span class="number">10000</span>;</span><br><span class="line">    String otpCode = String.valueOf(randomInt);</span><br><span class="line">    <span class="comment">//将OTP验证码同对应的手机号关联</span></span><br><span class="line">    httpServletRequest.setAttribute(telphone, otpCode);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将OTP验证码通过短信通道发送给用户（第三方服务，这里省略）</span></span><br><span class="line">    log.info(<span class="string">"telphone = "</span> + telphone + <span class="string">" &amp; otpCode = "</span> + otpCode);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> CommonReturnType.create(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>短信校验—服务层</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserModel <span class="title">validatelogin</span><span class="params">(String telphone, String encrptpassword)</span> <span class="keyword">throws</span> BusinessException </span>&#123;</span><br><span class="line">    <span class="comment">//通过手机号获取用户信息</span></span><br><span class="line">    UserDO userDO = userDOMapper.selectByTelphone(telphone);</span><br><span class="line">    <span class="keyword">if</span>(userDO == <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(EmBusinessError.USER_LOGIN_FAIL);</span><br><span class="line">    &#125;</span><br><span class="line">    UserPasswordDO userPasswordDO = userPasswordDOMapper.selectByPrimaryKey(userDO.getId());</span><br><span class="line"></span><br><span class="line">    UserModel userModel = convertFromDataObject(userDO, userPasswordDO);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//比对用户信息加密的密码是否与传输进来的密码匹配</span></span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.equals(encrptpassword, userModel.getEncrptPassword()))&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(EmBusinessError.USER_LOGIN_FAIL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> userModel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>注册—服务层</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span> <span class="comment">//事务</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(UserModel userModel)</span> <span class="keyword">throws</span> BusinessException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(userModel == <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(EmBusinessError.PARAMETER_VALIDATION_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*if(StringUtils.isEmpty(userModel.getName())</span></span><br><span class="line"><span class="comment">            ||userModel.getGender() == null</span></span><br><span class="line"><span class="comment">            ||userModel.getAge() == null</span></span><br><span class="line"><span class="comment">            ||StringUtils.isEmpty(userModel.getTelphone()))&#123;</span></span><br><span class="line"><span class="comment">        throw new BusinessException(EmBusinessError.PARAMETER_VALIDATION_ERROR);</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//使用hibenator参数校验工具</span></span><br><span class="line">    ValidationResult result = validator.validate(userModel);</span><br><span class="line">    <span class="keyword">if</span>(result.isHasErrors())&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(EmBusinessError.PARAMETER_VALIDATION_ERROR, result.getErrMsg());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//插入用户表</span></span><br><span class="line">    UserDO userDO = convertFromModel(userModel);</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        userDOMapper.insertSelective(userDO);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (DuplicateKeyException ex)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(EmBusinessError.PARAMETER_VALIDATION_ERROR, <span class="string">"手机号已重复注册"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//插入密码表，插入前先更新id(id会被mybatis自动更新)</span></span><br><span class="line">    userModel.setId(userDO.getId());</span><br><span class="line"></span><br><span class="line">    UserPasswordDO userPasswordDO = convertPasswordFromModel(userModel);</span><br><span class="line">    userPasswordDOMapper.insertSelective(userPasswordDO);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>登录—控制层</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用户登录接口</span></span><br><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/login"</span>, consumes = CONTENT_TYPE_FORMED)</span><br><span class="line"><span class="function"><span class="keyword">public</span> CommonReturnType <span class="title">login</span><span class="params">(@RequestParam(<span class="string">"telphone"</span>)</span>String telphone,</span></span><br><span class="line"><span class="function">                              @<span class="title">RequestParam</span><span class="params">(<span class="string">"password"</span>)</span>String password) <span class="keyword">throws</span> BusinessException, UnsupportedEncodingException, NoSuchAlgorithmException </span>&#123;</span><br><span class="line">    <span class="comment">//入参校验</span></span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isEmpty(telphone)||StringUtils.isEmpty(password))&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(EmBusinessError.PARAMETER_VALIDATION_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//用户登录服务，检验是否合法</span></span><br><span class="line">    UserModel userModel = userService.validatelogin(telphone, <span class="keyword">this</span>.EncodeByMD5(password));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将登陆凭证加入到用户登录成功的session内</span></span><br><span class="line">    <span class="keyword">this</span>.httpServletRequest.getSession().setAttribute(<span class="string">"IS_LOGIN"</span>, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">this</span>.httpServletRequest.getSession().setAttribute(<span class="string">"LOGIN_USER"</span>, userModel);</span><br><span class="line">    <span class="keyword">return</span> CommonReturnType.create(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>解决跨域session共享问题：<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xhbGFsYTMyMy9hcnRpY2xlL2RldGFpbHMvMTAzNjI1NjI1">https://blog.csdn.net/lalala323/article/details/103625625<i class="fa fa-external-link-alt"></i></span></p><h4 id="for-update-行级锁"><a href="#for-update-行级锁" class="headerlink" title="for update 行级锁"></a>for update 行级锁</h4><blockquote><p><code>for update</code>是一种行级锁，又叫排它锁，一旦用户对某个行施加了行级加锁，则该用户可以查询也可以更新被加锁的数据行，其它用户只能查询但不能更新被加锁的数据行．如果其它用户想更新该表中的数据行，则也必须对该表施加行级锁．即使多个用户对一个表均使用了共享更新，但也不允许两个事务同时对一个表进行更新，真正对表进行更新时，是以独占方式锁表，一直到提交或复原该事务为止。行锁永远是独占方式锁。</p></blockquote><p>只有当出现如下之一的条件，才会释放共享更新锁：<br>1、执行提交（COMMIT）语句<br>2、退出数据库（LOG　OFF）<br>3、程序停止运行</p><h4 id="Joda-Time-时间API"><a href="#Joda-Time-时间API" class="headerlink" title="Joda-Time 时间API"></a>Joda-Time 时间API</h4><p>使用该日期处理类替代java自带的，参考<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3BzaDE4NTEzMjM0NjMzL2FydGljbGUvZGV0YWlscy83OTQwODA5Ng==">https://blog.csdn.net/psh18513234633/article/details/79408096<i class="fa fa-external-link-alt"></i></span></p><h2 id="项目回顾"><a href="#项目回顾" class="headerlink" title="项目回顾"></a>项目回顾</h2><blockquote><p>推荐在SpringMVC架构中，领域模型使用<code>贫血模型</code>，即只提供对应属性的getter和setter方法，将后端处理逻辑放在service层</p></blockquote><h4 id="统一的异常处理器"><a href="#统一的异常处理器" class="headerlink" title="统一的异常处理器"></a>统一的异常处理器</h4><blockquote><p>在之前的项目中，异常处理器设置在BaseController基类中，由其它Controller继承该基类从而实现异常处理，这样存在的问题是，<strong>无法拦截不进入Controller的异常</strong>，所以需要使用Spring切面编程来拦截<code>GlobalExceptionHandler</code></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalExceptionHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(Exception<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    @<span class="title">ResponseBody</span></span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">CommonReturnType</span> <span class="title">doError</span>(<span class="title">HttpServletRequest</span> <span class="title">httpServletRequest</span></span></span><br><span class="line"><span class="class">            , <span class="title">HttpServletResponse</span> <span class="title">httpServletResponse</span></span></span><br><span class="line"><span class="class">            , <span class="title">Exception</span> <span class="title">ex</span>)</span>&#123;</span><br><span class="line">        ex.printStackTrace();</span><br><span class="line">        Map&lt;String, Object&gt; responseData = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span>(ex <span class="keyword">instanceof</span> BusinessException)&#123;</span><br><span class="line">            BusinessException businessException = (BusinessException)ex;</span><br><span class="line">            responseData.put(<span class="string">"errCode"</span>, businessException.getErrCode());</span><br><span class="line">            responseData.put(<span class="string">"errMsg"</span>, businessException.getErrMsg());</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(ex <span class="keyword">instanceof</span> ServletRequestBindingException)&#123;</span><br><span class="line">            <span class="comment">//即url参数丢失</span></span><br><span class="line">            responseData.put(<span class="string">"errCode"</span>, EmBusinessError.UNKONWN_ERROR.getErrCode());</span><br><span class="line">            responseData.put(<span class="string">"errMsg"</span>, <span class="string">"url绑定路由问题"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(ex <span class="keyword">instanceof</span> NoHandlerFoundException)&#123;</span><br><span class="line">            responseData.put(<span class="string">"errCode"</span>, EmBusinessError.UNKONWN_ERROR.getErrCode());</span><br><span class="line">            responseData.put(<span class="string">"errMsg"</span>, <span class="string">"没有找到对应的访问路径"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            responseData.put(<span class="string">"errCode"</span>, EmBusinessError.UNKONWN_ERROR.getErrCode());</span><br><span class="line">            responseData.put(<span class="string">"errMsg"</span>, EmBusinessError.UNKONWN_ERROR.getErrMsg());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> CommonReturnType.create(responseData, <span class="string">"fail"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在YML文件开启MVC相关异常</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mvc:</span></span><br><span class="line">  <span class="attr">throw-exception-if-no-handler-found:</span> <span class="literal">true</span> <span class="comment">#不存在handler便抛出异常</span></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="attr">add-mappings:</span> <span class="literal">false</span> <span class="comment">#不允许静态文件映射</span></span><br></pre></td></tr></table></figure><h4 id="云端部署"><a href="#云端部署" class="headerlink" title="云端部署"></a>云端部署</h4><p>项目打包成jar文件，数据库使用mysqldump备份，然后后果scp命令上传到服务器</p><blockquote><p>编写deploy脚本</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup java -Xms150m -Xmx300m -XX:NewSize=200m -XX:MaxNewSize=200m -jar miaosha.jar --spring.config.addition-location=/var/wwww/miaosha/application.yml</span><br></pre></td></tr></table></figure><blockquote><p>后台启动脚本</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./deploy.sh &amp;</span><br></pre></td></tr></table></figure><blockquote><p>查看控制台</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -200f nohup.out</span><br></pre></td></tr></table></figure><h4 id="性能压测"><a href="#性能压测" class="headerlink" title="性能压测"></a>性能压测</h4><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200830164436645.png" alt="Jmeter压测流程" style="zoom:67%"><p>主要关注聚合报告的<code>95线和TPS（QPS）数量</code></p><h4 id="发现并发容量问题"><a href="#发现并发容量问题" class="headerlink" title="发现并发容量问题"></a>发现并发容量问题</h4><blockquote><p>首先使用<code>ps -ef | grep java</code> 命令找到对应进程编号，如1313，然后使用<code>pstree -p 1313 |wc -l</code>查看其线程数量</p></blockquote><p>关于top -H参数的了解：</p><ul><li>CPU一行的：<code>us</code>代表用户态对CPU的占有率，同理<code>sy</code>代表内核态对CPU的占有率</li><li>第一行的：<code>load average</code>代表最近几分钟cpu的加载率，三个数分别代表不同时间段的系统平均负载（一分钟、五 分钟、以及十五分钟），它们的数字当然是越小越好。数字越高，说明服务器的负载越大，这也可能是服务器出现某种问题的信号。</li></ul><hr><p>SpringBoot默认的配置在<code>spring-configuration-metadata.json</code>下，该文件中指定了tomcat默认的线程数量</p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200830173253365.png" alt="Tomcat默认配置" style="zoom:67%"><hr><p>Tomcat连接定制</p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200830185827384.png" alt="Tomcat开发" style="zoom:67%"><p>编写定制类<code>WebServerConfiguration</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**当Spring容器内没有TomcatEmbeddedServletContainerFactory这个bean时，会把此bean加载进来</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: tosang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2020/8/30 19:02</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebServerConfiguration</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">WebServerFactoryCustomizer</span>&lt;<span class="title">ConfigurableWebServerFactory</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">customize</span><span class="params">(ConfigurableWebServerFactory factory)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//使用对应工厂类提供给我们的接口定制化我们的tomcat connector</span></span><br><span class="line">        ((TomcatServletWebServerFactory)factory).addConnectorCustomizers(<span class="keyword">new</span> TomcatConnectorCustomizer() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">customize</span><span class="params">(Connector connector)</span> </span>&#123;</span><br><span class="line">                Http11NioProtocol protocolHandler = (Http11NioProtocol) connector.getProtocolHandler();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//定制化keepalivetimeout,设置30s没有收到请求断开连接</span></span><br><span class="line">                protocolHandler.setKeepAliveTimeout(<span class="number">30000</span>);</span><br><span class="line">                <span class="comment">//当客户端发送超过10000个请求自动断开连接</span></span><br><span class="line">                protocolHandler.setMaxKeepAliveRequests(<span class="number">10000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p><strong>容量问题优化</strong>：</p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200830192231754.png" alt="单Web上限" style="zoom:67%"><p><strong>MySql QPS问题：</strong>Queries Per Second，意思是每秒查询率，是一台服务器每秒能够响应的查询次数（数据库中的每秒执行查询sql的次数），显然，这个不够全面，不能描述增删改，所以，不建议用qps来作为系统性能指标。</p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200830195357668.png" alt="MySql数据库QPS问题" style="zoom:67%"><p><strong>MySql TPS问题：</strong>Transactions Per Second，意思是每秒事务数，具体事务的定义，都是人为的，可以一个接口、多个接口、一个业务流程等等。一个事务是指事务内第一个请求发送到接收到最后一个请求的响应的过程，以此来计算使用的时间和完成的事务个数。</p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200830200530077.png" alt="MySql数据库TPS问题" style="zoom:67%"><h4 id="分布式扩展"><a href="#分布式扩展" class="headerlink" title="分布式扩展"></a>分布式扩展</h4><p>目标：</p><ul><li>Nginx反向代理负载均衡</li><li>分布式会话管理</li><li>使用redis实现分布式会话存储</li></ul><hr><p>单机容量问题：</p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200831094237735.png" alt="单机容量问题" style="zoom:67%"><p>水平扩展：</p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200831094545441.png" alt="水平扩展" style="zoom:80%"><p>新的架构图：</p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200831094721186.png" alt="Nginx反向代理" style="zoom:50%"><hr><p>Nginx动静分离、反向代理：在Nginx的/resources下存放静态资源，其它请求转发到后端服务器</p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200831155239617.png" alt="架构图" style="zoom:67%"><p>使用<code>OpenResty</code>工具来简化Nginx的编译配置，因为Nginx不支持动态连接，手动编译的工作量很大，安装流程<span class="exturl" data-url="aHR0cDovL29wZW5yZXN0eS5vcmcvY24vbGludXgtcGFja2FnZXMuaHRtbA==">http://openresty.org/cn/linux-packages.html<i class="fa fa-external-link-alt"></i></span></p><p>使用Ngnix web服务器：</p><p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200831163428783.png" alt="image-20200831163428783"></p><blockquote><p><strong>nginx动静分离服务:</strong></p></blockquote><ul><li>location节点其他路径:动态资源用</li><li>location节path特定<code>resources</code>:静态资源路径</li></ul><p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200831170225387.png" alt="image-20200831170225387"></p><p>注意反向代理时：<strong>应该将静态网页中的ajax请求设置为Nginx服务器公网IP，千万不能设置为Nginx内网IP</strong>，因为Ajax请求是在公网上发出的，并不能访问局域网。</p><p><code>Tomcat</code>日志配置：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">accesslog:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">directory:</span> <span class="string">/var/www/miaosha/tomcat</span></span><br><span class="line">  <span class="attr">pattern:</span> <span class="string">'%h %l %u %t "%r" %s %b %D'</span></span><br></pre></td></tr></table></figure><p>查看 <code>tail -f tomcat/access_log.2020-08-31.log</code> ：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">172.25.25.161 - - [31/Aug/2020:17:37:41 +0800] "GET /item/get?id=21 HTTP/1.0" 200 447 1226</span><br></pre></td></tr></table></figure><hr><p>开启Ngnix反向代理到内网服务器的<code>长链接</code>：减少tcp握手的消耗</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">upstream backend_server&#123;</span><br><span class="line">        server 172.25.25.160 weight=1;</span><br><span class="line">        server 172.25.25.159 weight=1;</span><br><span class="line">        keepalive 30; #开启长连接</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">location /resources/ &#123;</span><br><span class="line">            alias  /usr/local/openresty/nginx/html/resources/; #alias作用为：命中则替换</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://backend_server;</span><br><span class="line">            proxy_set_header Host $http_host:$proxy_port;</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">            proxy_http_version 1.1; #必须设置http1.1才支持长连接</span><br><span class="line">            proxy_set_header Connection ""; #必须设置为空</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>经Jmeter测试<code>1000个线程循环30次</code>在以下条件：</p><ul><li>mysql服务器：2核8g 20mbps</li><li>秒杀服务器1：2核8g 3mbps</li><li>秒杀服务器2：2核8g 3mbps</li><li>Nginx服务器：2核8g 25mbps</li><li>默认开启内网各服务器之间的长连接</li></ul><p>结果如图：</p><p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200831201908370.png" alt="压测数据"></p><hr><blockquote><p>Nginx高性能服务器的原因：</p></blockquote><ul><li><strong>epoll多路复用</strong></li><li><strong>master worker进程模型</strong></li><li><strong>协程机制</strong></li></ul><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200831202350866.png" alt="epoll多路复用" style="zoom:50%"><blockquote><p>select多路复用：</p></blockquote><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200831202800407.png" alt="select多路复用" style="zoom:67%"><blockquote><p>epoll模型：</p></blockquote><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200831203415321.png" alt="epoll模型" style="zoom:67%"><p><strong>JDK的NIO模型是借鉴了select模型核epoll建立的，其在linux 2.6以上内核运作时，便采用epoll模型</strong>；Dubbo的netty框架也是基于epoll模型的。</p><hr><blockquote><p>Nginx master-worker进程模型：</p></blockquote><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200831203721509.png" alt="image-2020083120372150" style="zoom:67%"><blockquote><p>说明：</p></blockquote><ul><li>master进程负责处理管理员命令和管理worker进程，实际上是worker进程<code>在内存抢占资源锁</code>来连接或拒绝socket请求。</li><li>worker进程只有一个线程，但并不意味着它的效率低，实际上当线程内部没有阻塞操作时，单线程比多线程更快速，<code>worker内部是不允许存在阻塞线程的，阻塞操作（如I/O）必须交给epoll模型</code></li></ul><hr><blockquote><p><code>Nginx</code>协程机制：</p></blockquote><ul><li><strong>依附于线程的内存模型，切换开销小</strong></li><li><strong>遇阻塞及归还执行权，代码同步</strong></li><li><strong>无需加锁</strong></li></ul><p>协程是一个<code>内存模型</code>，本质上还是一个线程，只不过一个线程可以有多个协程，协程不同于线程，<code>协程切换没有CPU的切换开销，只有内存的切换开销。</code> lua/golang语言都有协程机制</p><hr><blockquote><p>会话管理：</p></blockquote><ul><li>基于cookie传输sessionid : java tomcat容器session实现</li><li><strong>基于<code>token</code>传输类似sessionid : java代码session实现</strong>（推荐）</li></ul><p>基于cookie的方式，会在cookie中携带Jsession作为session的id</p><blockquote><p>然而在上面的分布式场景下，上面的两种方式都会存在问题，因为nginx进行轮询时两台tomcat服务器之间的session是无法共享的，会出现不停提示登录的问题。</p></blockquote><hr><p>使用<code>分布式会话</code>：</p><ul><li>基于cookie传输sessionid : java tomcat容器session实现迁移到<br>redis</li><li>基于token传输类似sessionid : java代码session实现迁移到redis</li></ul><blockquote><p>引入POM</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--redis依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>RedisConfig</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@EnableRedisHttpSession</span>(maxInactiveIntervalInSeconds = <span class="number">3600</span>) <span class="comment">//最大存活时间</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意要放入redis中的session数据必须实现<code>序列化接口</code>或者<code>修改redis默认的序列化方式</code></p><blockquote><p><strong>基于token传输：使用token传输可以避免移动设备不支持发送cookie的情况，兼容性更好</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//修改为若用户登录成功后将对应的登录信息和登录凭证存入redis中</span></span><br><span class="line"><span class="comment">//生成token,使用uuid</span></span><br><span class="line">String uuidToken = UUID.randomUUID().toString();</span><br><span class="line"></span><br><span class="line"><span class="comment">//建立token和用户登录态之间的联系，并设置超时时间</span></span><br><span class="line">redisTemplate.opsForValue().set(uuidToken, userModel);</span><br><span class="line">redisTemplate.expire(uuidToken, <span class="number">1</span>, TimeUnit.HOURS);</span><br><span class="line"></span><br><span class="line"><span class="comment">//下发token</span></span><br><span class="line"><span class="keyword">return</span> CommonReturnType.create(uuidToken);</span><br></pre></td></tr></table></figure><p>前端可以用<code>localStorage</code>存储token</p><h4 id="查询优化之多级缓存"><a href="#查询优化之多级缓存" class="headerlink" title="查询优化之多级缓存"></a>查询优化之多级缓存</h4><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200901155025174.png" alt="image-2020090115502517" style="zoom:67%"><p>多级缓存策略：</p><ul><li><strong>redis缓存</strong> —一级缓存 <strong>集中式的缓存管理</strong></li><li><strong>热点内存本地缓存</strong> —–二级缓存</li><li><strong>nginx proxy cache缓存</strong> —–三级缓存</li><li><strong>nginx lua缓存</strong></li></ul><blockquote><p>redis的sentinel哨兵模式：</p></blockquote><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200901162430901.png" alt="image-20200901162430901" style="zoom:80%"><p>一旦sentinel检测到心跳丢失，会切换主从并发送信号给miaosha.jar：</p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200901162647326.png" alt="image-20200901162647326" style="zoom:80%"><hr><blockquote><p>redis集群cluster模式：是一个雪花状集群，客户端只需要连接任意一台redis服务器即可，一旦某一台机器挂了，redis服务器会自带提示客户端重新拉取状态信息。</p></blockquote><hr><h5 id="商品详情页动态内容实现"><a href="#商品详情页动态内容实现" class="headerlink" title="商品详情页动态内容实现"></a>商品详情页动态内容实现</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据商品的id到redis内获取</span></span><br><span class="line">ItemModel itemModel = (ItemModel) redisTemplate.opsForValue().get(<span class="string">"item_"</span> + id);</span><br><span class="line"></span><br><span class="line"><span class="comment">//若redis内不存在对应的itemModel，则访问下游service</span></span><br><span class="line"><span class="keyword">if</span>(itemModel == <span class="keyword">null</span>)&#123;</span><br><span class="line">    itemModel = itemService.getItemById(id);</span><br><span class="line">    <span class="comment">//放入redis缓存</span></span><br><span class="line">    redisTemplate.opsForValue().set(<span class="string">"item_"</span> + id, itemModel);</span><br><span class="line">    redisTemplate.expire(<span class="string">"item_"</span> + id, <span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>修改redis默认的序列化机制</p></blockquote><p>由于对于秒杀的日期类型使用的<code>JodaTime</code>的<code>DateTime</code>，必须要手动实现其<code>序列化和反序列化</code>到redis的Json String样式。</p><blockquote><p>序列化类</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: tosang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2020/9/1 17:24</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JodaDateTimeJsonSerializer</span> <span class="keyword">extends</span> <span class="title">JsonSerializer</span>&lt;<span class="title">DateTime</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(DateTime dateTime, JsonGenerator jsonGenerator, SerializerProvider serializerProvider)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将DateTime转为String</span></span><br><span class="line">        jsonGenerator.writeString(dateTime.toString(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>反序列化类</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: tosang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2020/9/1 17:24</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JodaDateTimeJsonDeserializer</span> <span class="keyword">extends</span> <span class="title">JsonDeserializer</span>&lt;<span class="title">DateTime</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DateTime <span class="title">deserialize</span><span class="params">(JsonParser jsonParser, DeserializationContext deserializationContext)</span> <span class="keyword">throws</span> IOException, JsonProcessingException </span>&#123;</span><br><span class="line">        String s = jsonParser.readValueAs(String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        DateTimeFormatter dateTimeFormatter = DateTimeFormat.forPattern(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> DateTime.parse(s, dateTimeFormatter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>redis 配置类：使用上面的序列化和反序列化方式</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: tosang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2020/9/1 10:39</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@EnableRedisHttpSession</span>(maxInactiveIntervalInSeconds = <span class="number">3600</span>) <span class="comment">//最大存活时间</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span></span>&#123;</span><br><span class="line">        RedisTemplate redisTemplate = <span class="keyword">new</span> RedisTemplate();</span><br><span class="line">        redisTemplate.setConnectionFactory(redisConnectionFactory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//首先解决key的序列化方式</span></span><br><span class="line">        StringRedisSerializer stringRedisSerializer = <span class="keyword">new</span> StringRedisSerializer();</span><br><span class="line">        redisTemplate.setKeySerializer(stringRedisSerializer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//解决value的序列化方式，使用json</span></span><br><span class="line">        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer(Object<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        SimpleModule simpleModule = <span class="keyword">new</span> SimpleModule();</span><br><span class="line">        simpleModule.addSerializer(DateTime<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">JodaDateTimeJsonSerializer</span>())</span>;</span><br><span class="line">        simpleModule.addDeserializer(DateTime<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">JodaDateTimeJsonDeserializer</span>())</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//注意第二行的方式已经被遗弃，官方建议的方式如下</span></span><br><span class="line">        objectMapper.activateDefaultTyping(LaissezFaireSubTypeValidator.instance, ObjectMapper.DefaultTyping.NON_FINAL, JsonTypeInfo.As.PROPERTY);</span><br><span class="line">        <span class="comment">//objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span></span><br><span class="line">        objectMapper.registerModule(simpleModule);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(objectMapper);</span><br><span class="line">        redisTemplate.setValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p>再次部署发现，使用<code>redis</code>能明显提高并发量：</p><p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200901211222409.png" alt="image-20200901211222409"></p><h5 id="本地热点缓存"><a href="#本地热点缓存" class="headerlink" title="本地热点缓存"></a>本地热点缓存</h5><blockquote><p>对于超高频的数据，访问redis依然会有比较大的开销，所以设计本地热点数据缓存非常有必要</p></blockquote><ol><li>热点数据</li><li>脏读不敏感</li><li>内存可控</li></ol><p>理论上要满足后面两点，<strong>本地缓存必须比redis生命周期要短</strong>。</p><blockquote><p>注意：<strong>本地缓存不能使用<code>ConcurrentHashMap</code>，因为put操作加锁后对读锁的性能影响较大，而且还要考虑淘汰机制</strong></p></blockquote><p>使用<code>Guava cache</code>：</p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200901212647586.png" alt="image-20200901212647586" style="zoom:50%"><blockquote><p>引入POM</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>22.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>定义CacheServiceImpl</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: tosang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2020/9/1 21:34</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheServiceImpl</span> <span class="keyword">implements</span> <span class="title">CacheService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Cache&lt;String, Object&gt; commonCache = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//该注解定义bean依赖注入后的初始化方法</span></span><br><span class="line">    <span class="comment">//目的是不让commonCache一开始就生成在内存中</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        commonCache = CacheBuilder.newBuilder()</span><br><span class="line">                .initialCapacity(<span class="number">10</span>)<span class="comment">//初始容量</span></span><br><span class="line">                .maximumSize(<span class="number">100</span>)<span class="comment">//最大容量，超过后，按照LRU策略移除缓存项</span></span><br><span class="line">                .expireAfterWrite(<span class="number">60</span>, TimeUnit.SECONDS)<span class="comment">//写后多少秒过期</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCommonCache</span><span class="params">(String key, Object value)</span> </span>&#123;</span><br><span class="line">        commonCache.put(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getFromCommonCache</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> commonCache.getIfPresent(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后取数据的顺序为：<strong>先找本地缓存，本地不存在找redis，然后再找mysql</strong></p><blockquote><p>再次测试Jmeter可以达到<code>3000TPS</code></p></blockquote><hr><h5 id="nginx-proxy-cache缓存"><a href="#nginx-proxy-cache缓存" class="headerlink" title="nginx proxy cache缓存"></a>nginx proxy cache缓存</h5><ol><li>nginx反向代理前置</li><li>依靠文件系统存索引级的文件</li><li>依靠内存缓存文件地址</li></ol><blockquote><p><strong>由于nginx的缓存使用的是文件系统，并非缓存在内存上，所以这样配置并不能提高并发量</strong></p></blockquote><hr><blockquote><p>nginx lua</p></blockquote><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200902173312029.png" alt="nginx lua" style="zoom:67%"><blockquote><p>lua协程机制</p></blockquote><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200902173507164.png" alt="image-20200902173507164" style="zoom:80%"><blockquote><p>nginx协程</p></blockquote><p><code>举例</code>：nginx遇到请求需要反向代理到后端服务器，等待后端服务器返回，协程便放弃自己的执行权限，<strong>将与后端的socket事件注册到epoll事件中</strong>，等待epoll事件被唤醒回调，nginx又会创建新的协程来完成后续操作</p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200902175227355.png" alt="image-20200902175227355" style="zoom:67%"> <img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200902175419543.png" alt="image-20200902175419543" style="zoom:67%"><blockquote><p>lua插载点</p></blockquote><p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200902180016713.png" alt="image-20200902180016713"></p><blockquote><p>常用插载点</p></blockquote><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200902180558228.png" alt="image-20200902180558228" style="zoom:80%"><blockquote><p>OpenResty实践</p></blockquote><ul><li>openresty hello world</li><li><code>shared dic</code>:共享内存字典，所有worker进程可见，Iru淘汰</li></ul><blockquote><p>lua脚本使用<code>share dic</code></p></blockquote><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_from_cache</span><span class="params">(key)</span></span></span><br><span class="line">        <span class="keyword">local</span> cache_ngx = ngx.shared.my_cache</span><br><span class="line">        <span class="keyword">local</span> value = cache_ngx.get(key)</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_to_cache</span><span class="params">(key, value, exptime)</span></span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> exptime <span class="keyword">then</span></span><br><span class="line">                exptime = <span class="number">0</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">local</span> cache_ngx = ngx.shared.my_cache</span><br><span class="line">        <span class="keyword">local</span> succ, err, forcible = cache_ngx:set(key, value, exptime)</span><br><span class="line">        <span class="keyword">return</span> succ</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> args = ngx.req.get_uri_args()</span><br><span class="line"><span class="keyword">local</span> id = args[<span class="string">"id"</span>]</span><br><span class="line"><span class="keyword">local</span> item_model = get_from_cache(<span class="string">"item_"</span>..id)</span><br><span class="line"><span class="keyword">if</span> item_model = <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> resp = ngx.location.capture(<span class="string">"/item/get?id="</span>..id)</span><br><span class="line">        item_model = resp.body</span><br><span class="line">        set_to_cache(<span class="string">"item_"</span>..id, item_model, <span class="number">1</span>*<span class="number">60</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><blockquote><p>nginx使用redis</p></blockquote><p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200902205723205.png" alt="image-20200902205723205"></p><h4 id="查询优化之页面静态化"><a href="#查询优化之页面静态化" class="headerlink" title="查询优化之页面静态化"></a>查询优化之页面静态化</h4><blockquote><p>静态请求CDN</p></blockquote><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903100238028.png" alt="image-20200903100238028" style="zoom:80%"><blockquote><p>回源缓存</p></blockquote><p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903100756596.png" alt="image-20200903100756596"></p><blockquote><p>有效性判断</p></blockquote><p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903101054624.png" alt="image-20200903101054624"></p><blockquote><p>浏览器刷新方式</p></blockquote><p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903101337847.png" alt="image-20200903101337847"></p><ul><li>ctrl+F5或commond+shift+R刷新:去掉cache-control<br>和协商头，强制刷新</li><li>协商机制，比较Last-modified和ETag到服务端，若服务端<br>判断没变化则304不返回数据，否则200返回数据</li></ul><blockquote><p>CDN自定义缓存策略</p></blockquote><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903103842078.png" alt="image-20200903103842078" style="zoom:80%"><hr><blockquote><p>静态资源部署策略</p></blockquote><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903104638201.png" alt="image-20200903104638201" style="zoom:80%"> <img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903104818774.png" alt="image-20200903104818774" style="zoom:80%"><hr><h5 id="全页面静态化"><a href="#全页面静态化" class="headerlink" title="全页面静态化"></a>全页面静态化</h5><p><strong>定义:</strong></p><ul><li>在服务端完成html , css，甚至js的load渲染成纯html文件后直接以静态资源的方式部署到cdn上</li></ul><p>全页面静态化技术类似于爬虫技术</p><blockquote><p><code>phantomjs</code></p></blockquote><p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903110933494.png" alt="image-20200903110933494"></p><blockquote><p>示例：首先编写一个爬虫js文件，该爬虫负责获取前端页面</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> page = <span class="built_in">require</span>(<span class="string">"webpage"</span>).create();</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line">page.open(<span class="string">"http://localhost:8080/resources/getitem.html?id=21"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">status</span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"status = "</span> + status);</span><br><span class="line">                <span class="keyword">var</span> isInit = <span class="string">"0"</span>;</span><br><span class="line">                setInterval(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                        <span class="keyword">if</span>(isInit != <span class="string">"1"</span>)&#123;</span><br><span class="line">                                page.evaluate(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                                        initView();     </span><br><span class="line">                                &#125;);     </span><br><span class="line">                                isInit = page.evaluate(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                                        <span class="keyword">return</span> hasInit();</span><br><span class="line">                                &#125;);</span><br><span class="line">                        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                                fs.write(<span class="string">"getitem.html"</span>, page.content, <span class="string">"w"</span>);</span><br><span class="line">                                phantom.exit();</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><blockquote><p>修改前端页面：使得ajax请求可以被爬虫控制</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type=<span class="string">"hidden"</span> id=<span class="string">"isInit"</span> value=<span class="string">"0"</span>/&gt;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hasInit</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> isInit = $(<span class="string">"#isInit"</span>).val();</span><br><span class="line">    <span class="keyword">return</span> isInit;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setHasInit</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    $(<span class="string">"#isInit"</span>).val(<span class="string">"1"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initView</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> isInit = hasInit();</span><br><span class="line">    <span class="keyword">if</span>(isInit == <span class="string">"1"</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//使用ajax获取商品详情</span></span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        type:<span class="string">"GET"</span>,</span><br><span class="line">        url: <span class="string">"http://"</span>+g_host+<span class="string">"/item/get"</span>,</span><br><span class="line">        data:&#123;</span><br><span class="line">            <span class="string">"id"</span>: getParam(<span class="string">"id"</span>),</span><br><span class="line">        &#125;,</span><br><span class="line">        xhrFields:&#123;<span class="attr">withCredentials</span>:<span class="literal">true</span>&#125;,</span><br><span class="line">        success:<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(data.status == <span class="string">"success"</span>)&#123;</span><br><span class="line">                g_itemVO = data.data;</span><br><span class="line">                reloadDom();</span><br><span class="line">                setInterval(reloadDom, <span class="number">1000</span>);</span><br><span class="line">                setHasInit();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                alert(<span class="string">"获取信息失败，原因为"</span>+data.data.errMsg)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        error:<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">            alert(<span class="string">"获取信息失败，原因为"</span>+data.responseText)</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="交易优化之缓存库存"><a href="#交易优化之缓存库存" class="headerlink" title="交易优化之缓存库存"></a>交易优化之缓存库存</h4><p>下单的性能瓶颈：</p><blockquote><p>一次下单至少产生6次的数据库I/O操作，实际上是非常耗时的</p></blockquote><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903155243655.png" alt="image-20200903155243655" style="zoom:67%"> <img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903155315817.png" alt="image-20200903155315817" style="zoom:67%"><blockquote><p>上面的<code>用户信息</code>和<code>活动信息</code>查询都可以使用redis缓存来优化，Jmeter压测结果提升会相当明显</p></blockquote><hr><p>库存表添加索引：因为每次写都添加行锁必然要对应有索引，不然速度会很慢</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> item_stock <span class="keyword">add</span> <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> item_id_index(item_id)</span><br></pre></td></tr></table></figure><blockquote><p>库存行锁优化</p></blockquote><ul><li><strong>扣减库存缓存化</strong></li><li><strong>异步同步数据库</strong></li><li><strong>库存数据库最终一致性保证</strong></li></ul><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903171306189.png" alt="image-20200903171306189" style="zoom:67%"><blockquote><p>活动发布服务</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishPromo</span><span class="params">(Integer promoId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//通过活动id获取活动</span></span><br><span class="line">    PromoDO promoDO = promoDOMapper.selectByPrimaryKey(promoId);</span><br><span class="line">    <span class="keyword">if</span>(promoDO.getItemId() == <span class="keyword">null</span> || promoDO.getItemId().intValue() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ItemModel itemModel = itemService.getItemById(promoDO.getItemId());</span><br><span class="line">    <span class="comment">//这样设计的前提是秒杀商品在活动开始前不能进行售卖，否则库存会与缓存不一致</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//将库存同步到redis内</span></span><br><span class="line">    redisTemplate.opsForValue().set(<span class="string">"promo_item_stock_"</span>+ itemModel.getId(), itemModel.getStock());  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>控制层：由运维调用该方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/publishpromo"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> CommonReturnType <span class="title">publishPromo</span><span class="params">(@RequestParam(<span class="string">"id"</span>)</span>Integer id) </span>&#123;</span><br><span class="line">    promoService.publishPromo(id);</span><br><span class="line">    <span class="keyword">return</span> CommonReturnType.create(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>减库存操作</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">decreaseStock</span><span class="params">(Integer itemId, Integer amount)</span> <span class="keyword">throws</span> BusinessException </span>&#123;</span><br><span class="line">    <span class="comment">//int affectedRow = itemStockDOMapper.decreaseStock(itemId, amount);</span></span><br><span class="line">    Long result = redisTemplate.opsForValue().increment(<span class="string">"promo_item_stock_"</span> + itemId, amount.intValue() * -<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(result &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">//更新成功</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//更新库存失败</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p>问题：<strong>上面的操作会有数据库记录不一致问题</strong></p><p>解决方案：<strong>使用异步消息扣减数据库库存</strong></p><blockquote><p>使用rockmq来发送异步消息</p></blockquote><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903180924669.png" alt="image-20200903180924669" style="zoom:80%"><blockquote><p>分布式事务</p></blockquote><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903181450189.png" alt="image-20200903181450189" style="zoom:80%"><p>显然分布式事务中，无法同时满足<code>CAP</code>理论，因此<code>BASE</code>理论提出了柔性事务，即满足最终的一致性即可</p><blockquote><p>使用异步消息存在的问题</p></blockquote><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200903214017836.png" alt="image-20200903214017836" style="zoom:80%"><blockquote><p><strong>缺少下单的记录</strong>，一旦失败，无法回滚</p></blockquote><h4 id="交易性能优化之事务型消息"><a href="#交易性能优化之事务型消息" class="headerlink" title="交易性能优化之事务型消息"></a>交易性能优化之事务型消息</h4><p>由于在下单的整个事务中，落单成功，但是入库可能失败，导致这个事务回滚，而库存却被扣减的问题。</p><blockquote><p>思路1：<strong>在下单的整个事务之后添加一个后执行方法，允许扣减redis库存，但必须等事务提交了再发送<code>异步消息</code>到数据库库存，保证在事务发送回滚时，库存不会被扣减</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">TransactionSynchronizationManager.registerSynchronization(</span><br><span class="line">        <span class="keyword">new</span> TransactionSynchronization() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCommit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">//异步更新库存，当上面的事务回滚，下面异步消息不会发送，数据库不会减库存</span></span><br><span class="line">                <span class="keyword">boolean</span> mqResult = itemService.asyncDecreaseStock(itemId, amount);</span><br><span class="line">                <span class="comment">/*if(!mqResult)&#123;</span></span><br><span class="line"><span class="comment">                    itemService.increaseStock(itemId, amount);</span></span><br><span class="line"><span class="comment">                    throw new BusinessException(EmBusinessError.MQ_SEND_FAIL);</span></span><br><span class="line"><span class="comment">                &#125;*/</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>上面的方法依然存在问题：无法保证<code>异步消息</code>绝对的可以被发送，如果刚好在<code>afterCommit</code>方法发送异常，就依然会导致库存更新失败。</p><blockquote><p>思路2：使用rocketMQ的事务型消息</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> MQClientException </span>&#123;</span><br><span class="line">    <span class="comment">//做mq producer的初始化</span></span><br><span class="line">    producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">"producer_group"</span>);</span><br><span class="line">    producer.setNamesrvAddr(nameAddr);</span><br><span class="line"></span><br><span class="line">    producer.start();</span><br><span class="line"></span><br><span class="line">    transactionMQProducer =</span><br><span class="line">            <span class="keyword">new</span> TransactionMQProducer(<span class="string">"transaction_producer_group"</span>);</span><br><span class="line">    transactionMQProducer.setNamesrvAddr(nameAddr);</span><br><span class="line">    transactionMQProducer.start();</span><br><span class="line">    transactionMQProducer.setTransactionListener(<span class="keyword">new</span> TransactionListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> LocalTransactionState <span class="title">executeLocalTransaction</span><span class="params">(Message message, Object args)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//真正要做的事，创建订单</span></span><br><span class="line">            Integer itemId = (Integer) ((Map)args).get(<span class="string">"itemId"</span>);</span><br><span class="line">            Integer promoId = (Integer) ((Map)args).get(<span class="string">"PromoId"</span>);</span><br><span class="line">            Integer userId = (Integer) ((Map)args).get(<span class="string">"UserId"</span>);</span><br><span class="line">            Integer amount = (Integer) ((Map)args).get(<span class="string">"amount"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                orderService.createOrder(userId, itemId, promoId, amount);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (BusinessException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="keyword">return</span> LocalTransactionState.ROLLBACK_MESSAGE;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> LocalTransactionState <span class="title">checkLocalTransaction</span><span class="params">(MessageExt messageExt)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//事务型同步库存扣减消息</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">transactionAsyncReduceStock</span><span class="params">(Integer userId, Integer promoId, Integer itemId, Integer amount)</span> </span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; bodyMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    Map&lt;String, Object&gt; argsMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    bodyMap.put(<span class="string">"itemId"</span>, itemId);</span><br><span class="line">    bodyMap.put(<span class="string">"amount"</span>, amount);</span><br><span class="line"></span><br><span class="line">    argsMap.put(<span class="string">"itemId"</span>, itemId);</span><br><span class="line">    argsMap.put(<span class="string">"amount"</span>, amount);</span><br><span class="line">    argsMap.put(<span class="string">"userId"</span>, promoId);</span><br><span class="line">    argsMap.put(<span class="string">"promoId"</span>, promoId);</span><br><span class="line"></span><br><span class="line">    TransactionSendResult transactionSendResult = <span class="keyword">null</span>;</span><br><span class="line">    Message message = <span class="keyword">new</span> Message(topicName, <span class="string">"increase"</span></span><br><span class="line">            , JSON.toJSON(bodyMap).toString().getBytes(Charset.forName(<span class="string">"UTF-8"</span>)));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        transactionSendResult = transactionMQProducer.sendMessageInTransaction(message, argsMap);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (MQClientException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(transactionSendResult.getLocalTransactionState() == LocalTransactionState.ROLLBACK_MESSAGE)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(transactionSendResult.getLocalTransactionState() == LocalTransactionState.COMMIT_MESSAGE)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后直接在控制层调用<code>transactionAsyncReduceStock</code>方法即可：</p><p>该方法的逻辑为：<code>bodyMap</code>为要发送的消息，<code>argsMap</code>为参数，<code>sendMessageInTransaction</code>往<code>rocketMQ</code>发送消息的同时回调<code>executeLocalTransaction</code>方法并将参数传递进去，在该方法内部调用订单创建的方法。</p><hr><h5 id="库存流水"><a href="#库存流水" class="headerlink" title="库存流水"></a>库存流水</h5><p>上面的操作还存在一个本质问题，<strong>没有库存流水</strong>，也就是去redis查询时并不知道是哪一笔订单出了问题。</p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200904112701538.png" alt="image-20200904112701538" style="zoom:80%"><blockquote><p>新建一张表来记录流水</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for stock_log</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`stock_log`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`stock_log`</span> (</span><br><span class="line">  <span class="string">`stock_log_id`</span> <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">COLLATE</span> utf8_unicode_ci <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`item_id`</span> <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span>,</span><br><span class="line">  <span class="string">`amount`</span> <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span>,</span><br><span class="line">  <span class="string">`status`</span> <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'//1表示初始状态，2表示下单扣减库存成功，3表示下单回滚'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`stock_log_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COLLATE</span>=utf8_unicode_ci;</span><br></pre></td></tr></table></figure><blockquote><p>库存数据库最终一致性</p></blockquote><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200904162454219.png" alt="image-20200904162454219" style="zoom:50%"><p><strong>设计原则</strong>:</p><ul><li>宁可少卖，不能超卖</li></ul><p><strong>方案:</strong></p><ul><li>redis可以比实际数据库中少</li><li>超时释放</li></ul><blockquote><p>库存售罄</p></blockquote><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200904163627831.png" alt="image-20200904163627831" style="zoom:50%"><blockquote><p>增加判断库存售空的情况：不进入下单流水号</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">decreaseStock</span><span class="params">(Integer itemId, Integer amount)</span> <span class="keyword">throws</span> BusinessException </span>&#123;</span><br><span class="line">    <span class="comment">//int affectedRow = itemStockDOMapper.decreaseStock(itemId, amount);</span></span><br><span class="line">    Long result = redisTemplate.opsForValue().increment(<span class="string">"promo_item_stock_"</span> + itemId, amount.intValue() * -<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(result &gt;= <span class="number">0</span>)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(result == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">//打上库存已经售罄的标识</span></span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">"promo_item_stock_invalid_"</span> + itemId, <span class="string">"true"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//更新库存失败，回滚</span></span><br><span class="line">        increaseStock(itemId, amount);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//在orderController添加</span></span><br><span class="line"><span class="comment">//判断是否库存已售罄，若对应的售罄key存在，则直接返回下单失败</span></span><br><span class="line"><span class="keyword">if</span>(redisTemplate.hasKey(<span class="string">"promo_item_stock_invalid_"</span> + itemId))&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(EmBusinessError.STOCK_NOT_ENOUGH);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200904170053689.png" alt="image-20200904170053689"></p><hr><h4 id="流量削峰"><a href="#流量削峰" class="headerlink" title="流量削峰"></a>流量削峰</h4><p>上面设计存在的问题：</p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200904171428254.png" alt="image-20200904171428254" style="zoom:50%"><blockquote><p>使用秒杀令牌</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//生成秒杀令牌</span></span><br><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/generatetoken"</span>, consumes = CONTENT_TYPE_FORMED)</span><br><span class="line"><span class="function"><span class="keyword">public</span> CommonReturnType <span class="title">generatetoken</span><span class="params">(@RequestParam(<span class="string">"itemId"</span>)</span>Integer itemId</span></span><br><span class="line"><span class="function">        ,@<span class="title">RequestParam</span><span class="params">(name = <span class="string">"promoId"</span>)</span>Integer promoId) <span class="keyword">throws</span> BusinessException </span>&#123;</span><br><span class="line">    <span class="comment">//获取用户的登录信息</span></span><br><span class="line">    String token = httpServletRequest.getParameterMap().get(<span class="string">"token"</span>)[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isEmpty(token))&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(EmBusinessError.USER_NOT_LOGIN, <span class="string">"用户未登录，不能下单"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取用户的登录信息</span></span><br><span class="line">    UserModel userModel = (UserModel) redisTemplate.opsForValue().get(token);</span><br><span class="line">    <span class="keyword">if</span>(userModel == <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="comment">//超时，数据丢失</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(EmBusinessError.USER_NOT_LOGIN, <span class="string">"用户未登录，不能下单"</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取秒杀访问令牌</span></span><br><span class="line">    String promoToken = promoService.generateSecondKillToken(promoId, itemId, userModel.getId());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(promoToken == <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(EmBusinessError.PARAMETER_VALIDATION_ERROR, <span class="string">"生成令牌失败"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> CommonReturnType.create(promoToken);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>前端首先发送<code>/generatetoken</code>请求来获取令牌，，此时该令牌会发送到<code>redis</code>服务器，然后才可以进行下单的请求，下单请求将验证当前的令牌是否与redis中的令牌一致，由于</p><blockquote><p>缺陷：秒杀令牌只要活动一开始就无限制生成，影响系统性能</p></blockquote><hr><h5 id="秒杀大闸原理"><a href="#秒杀大闸原理" class="headerlink" title="秒杀大闸原理"></a>秒杀大闸原理</h5><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200905101814367.png" alt="image-20200905101814367" style="zoom:67%"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将大闸的限制数设置到到redis中</span></span><br><span class="line">redisTemplate.opsForValue().set(<span class="string">"promo_door_count_"</span>+ promoId,</span><br><span class="line">        itemModel.getStock().intValue()*<span class="number">5</span>);</span><br></pre></td></tr></table></figure><p>这样流量进来时，进行一个限流，只有itemModel.getStock().intValue()*5的用户才有秒杀资格。</p><p><strong>缺陷：</strong></p><ul><li><strong>浪涌流量涌入后系统无法应对</strong></li><li><strong>多库存，多商品等令牌限制能力弱</strong></li></ul><blockquote><p>队列泄洪原理</p></blockquote><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200905104343819.png" alt="image-20200905104343819" style="zoom:67%"><blockquote><p><strong>使用线程池：每次只允许20个线程去创建订单，其余用户进入等待队列</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//新建20个线程的线程池</span></span><br><span class="line">        executorService = Executors.newFixedThreadPool(<span class="number">20</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//同步调用线程池的submit方法</span></span><br><span class="line"><span class="comment">//拥塞窗口为20的等待队列，用来队列化泄洪</span></span><br><span class="line">Future&lt;Object&gt; future = executorService.submit(<span class="keyword">new</span> Callable&lt;Object&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//加入库存流水init状态</span></span><br><span class="line">        String stockLogId = itemService.initStockLog(itemId, amount);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//再去完成对应的下单事务型消息</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建订单</span></span><br><span class="line">        <span class="comment">//OrderModel order = orderService.createOrder(userModel.getId(), itemId, promoId, amount);</span></span><br><span class="line">        <span class="keyword">boolean</span> b = mqProducer.transactionAsyncReduceStock(userModel.getId(), promoId, itemId, amount, stockLogId);</span><br><span class="line">        <span class="keyword">if</span> (!b) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(EmBusinessError.UNKONWN_ERROR, <span class="string">"下单失败"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    future.get();</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(EmBusinessError.UNKONWN_ERROR);</span><br><span class="line">&#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(EmBusinessError.UNKONWN_ERROR);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200905112151722.png" alt="image-20200905112151722"></p><blockquote><p><strong>建议将队列维护在本地内存。因为redis有网络的消耗</strong></p></blockquote><h4 id="防刷限流技术"><a href="#防刷限流技术" class="headerlink" title="防刷限流技术"></a>防刷限流技术</h4><blockquote><p>使用验证码防刷，此处省略。</p></blockquote><hr><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200909112655053.png" alt="image-20200909112655053" style="zoom:50%"> <img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200909112850039.png" alt="image-20200909112850039" style="zoom:50%"><blockquote><p>在互联网项目中，一般使用令牌桶算法。</p></blockquote><hr><blockquote><p>限流算法实现：基于谷歌的Guava</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//令牌桶</span></span><br><span class="line"><span class="keyword">private</span> RateLimiter orderCreateRateLimiter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//允许300个令牌</span></span><br><span class="line">    orderCreateRateLimiter = RateLimiter.create(<span class="number">300</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用时判断</span></span><br><span class="line"><span class="keyword">if</span>(!orderCreateRateLimiter.tryAcquire())&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(EmBusinessError.RATELIMIT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><blockquote><p>防刷技术</p></blockquote><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200909163050744.png" alt="image-20200909163050744" style="zoom:67%"><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200909163649212.png" alt="image-20200909163649212"></p><h3 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h3><h4 id="关于登录相关问题："><a href="#关于登录相关问题：" class="headerlink" title="关于登录相关问题："></a>关于登录相关问题：</h4><ol><li><p><code>session</code>一般定义呆滞时间为30分钟时间。</p></li><li><p>安全性问题：<code>Https</code>和自定义协议(APP中一般使用二进制加密，如使用<code>protobuf</code>协议)</p></li><li><p>弱登录态：即推荐算法，不登陆也会智能推荐，需要在session会话结束前续命（<strong>模拟心跳：在js上设置一个定时器，每隔几秒向服务端发送一个keepalive请求</strong>）。</p></li><li><p><code>SSO</code>单点登录：<strong>同一个域名只能有一个cookie且唯一，导致会出现访问不同页面需要重复登录的问题，因此需要单点登录。</strong>分为以下三种情况：</p><ol><li>同域名：cookie相同，SSO只需要保证使用同一个存储的ID即可。</li><li>跟域名相同而子域名不同：设置http的domain=/，这样设置，服务器只会关注<strong>根域名</strong>，从而生成相同的cookie</li><li><strong>域名都不相同</strong>：</li></ol><p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200909201407037.png" alt="image-20200909201407037"></p></li></ol><hr><h4 id="mysql性能提升"><a href="#mysql性能提升" class="headerlink" title="mysql性能提升"></a><strong><code>mysql</code>性能提升</strong></h4><p><strong>以下均以<code>innodb</code>引擎为例</strong>。</p><p>秘诀：遇到性能优化问题，使用：</p><ul><li><strong>缓存</strong></li><li><strong>异步</strong></li><li><strong>批处理</strong>：批量insert，批量update，避免for循环</li></ul><blockquote><p>批处理示例：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//for循环</span></span><br><span class="line"><span class="keyword">for</span> each &#123;<span class="function">insert into table <span class="title">values</span> <span class="params">(<span class="number">1</span>)</span>&#125;</span></span><br><span class="line"><span class="function"><span class="comment">//批量插入，尤其是正对json数组格式的数据</span></span></span><br><span class="line"><span class="function">Execute once insert into table <span class="title">values</span> <span class="params">(<span class="number">1</span>)</span>,<span class="params">(<span class="number">2</span>)</span>,<span class="params">(<span class="number">3</span>)</span>，<span class="params">(<span class="number">4</span>)</span>...</span>;</span><br></pre></td></tr></table></figure><p>批量写的优势：</p><ul><li>Sql编译N次和1次的时间与空间复杂度</li><li>网络消耗的时间复杂度</li><li>磁盘寻址的复杂度</li></ul><blockquote><p>使用索引</p></blockquote><hr><blockquote><p>mysql单机性能优化</p></blockquote><p>参数优化：</p><ul><li>max_connection=1000</li><li>innodb_file_per_table=1。即每个table作为一张表文件，而不是一个全部表在一个文件中。</li><li>innodb_buffer_pool_size=1G。数据读写时，先读写buffer。该参数一般设为内存60-70%。</li><li>innodb_log_file_size=256M</li><li>innodb_log_buffer_size=16M</li><li>innodb_flush_log_at_trx_commit= 2。<strong>即undo/redo日志先写入文件系统，但不执行flush操作，由于写入文件系统时（缓存区域）已经是linux操作系统内核态的操作级别，只要系统不断电就一定能写入成功，然后再依次进行flush操作</strong>。需要放在[mysqld_safe]节点</li><li>innodb_data_file_path=ibdata1:1G;ibdata2:1G;ibdata3:1G:auto extend。设置文件大小到1g时新建文件</li></ul><p><img data-src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/image-20200909210603922.png" alt="image-20200909210603922"></p><blockquote><p>mysql分布式扩展</p></blockquote><ul><li>开启<code>bin log</code></li><li>色湖之主从同步账号，配置主从同步。</li></ul></div><div class="post-widgets"><div id="needsharebutton-postbottom"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>tosang</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="http://uestc-toy.github.io/2020/08/16/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" title="秒杀系统设计">http://uestc-toy.github.io/2020/08/16/秒杀系统设计/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Java/" rel="tag"><i class="fa fa-tag"></i> Java</a> <a href="/tags/%E7%A7%92%E6%9D%80/" rel="tag"><i class="fa fa-tag"></i> 秒杀</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2020/07/28/SpringCloud%E4%B9%8B%E8%B6%8B%E5%8A%BF%E6%8A%95%E8%B5%84%E5%AE%9E%E8%B7%B5/" rel="prev" title="SpringCloud之趋势投资实践"><i class="fa fa-chevron-left"></i> SpringCloud之趋势投资实践</a></div><div class="post-nav-item"><a href="/2020/11/05/%E2%80%9D%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E2%80%9C/" rel="next" title="并发编程">并发编程 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="valine-comments"></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#项目构成"><span class="nav-number">1.</span> <span class="nav-text">项目构成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#秒杀项目搭建"><span class="nav-number">2.</span> <span class="nav-text">秒杀项目搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建数据库表结构"><span class="nav-number">2.0.1.</span> <span class="nav-text">创建数据库表结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#领域对象模型"><span class="nav-number">2.0.2.</span> <span class="nav-text">领域对象模型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#异常处理机制"><span class="nav-number">2.0.3.</span> <span class="nav-text">异常处理机制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#用户信息管理"><span class="nav-number">2.0.4.</span> <span class="nav-text">用户信息管理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#for-update-行级锁"><span class="nav-number">2.0.5.</span> <span class="nav-text">for update 行级锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Joda-Time-时间API"><span class="nav-number">2.0.6.</span> <span class="nav-text">Joda-Time 时间API</span></a></li></ol></li></ol><li class="nav-item nav-level-2"><a class="nav-link" href="#项目回顾"><span class="nav-number">3.</span> <span class="nav-text">项目回顾</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#统一的异常处理器"><span class="nav-number">3.0.1.</span> <span class="nav-text">统一的异常处理器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#云端部署"><span class="nav-number">3.0.2.</span> <span class="nav-text">云端部署</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#性能压测"><span class="nav-number">3.0.3.</span> <span class="nav-text">性能压测</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#发现并发容量问题"><span class="nav-number">3.0.4.</span> <span class="nav-text">发现并发容量问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分布式扩展"><span class="nav-number">3.0.5.</span> <span class="nav-text">分布式扩展</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查询优化之多级缓存"><span class="nav-number">3.0.6.</span> <span class="nav-text">查询优化之多级缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#商品详情页动态内容实现"><span class="nav-number">3.0.6.1.</span> <span class="nav-text">商品详情页动态内容实现</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#本地热点缓存"><span class="nav-number">3.0.6.2.</span> <span class="nav-text">本地热点缓存</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#nginx-proxy-cache缓存"><span class="nav-number">3.0.6.3.</span> <span class="nav-text">nginx proxy cache缓存</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查询优化之页面静态化"><span class="nav-number">3.0.7.</span> <span class="nav-text">查询优化之页面静态化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#全页面静态化"><span class="nav-number">3.0.7.1.</span> <span class="nav-text">全页面静态化</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#交易优化之缓存库存"><span class="nav-number">3.0.8.</span> <span class="nav-text">交易优化之缓存库存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#交易性能优化之事务型消息"><span class="nav-number">3.0.9.</span> <span class="nav-text">交易性能优化之事务型消息</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#库存流水"><span class="nav-number">3.0.9.1.</span> <span class="nav-text">库存流水</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#流量削峰"><span class="nav-number">3.0.10.</span> <span class="nav-text">流量削峰</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#秒杀大闸原理"><span class="nav-number">3.0.10.1.</span> <span class="nav-text">秒杀大闸原理</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#防刷限流技术"><span class="nav-number">3.0.11.</span> <span class="nav-text">防刷限流技术</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结"><span class="nav-number">3.1.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拓展"><span class="nav-number">3.2.</span> <span class="nav-text">拓展</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#关于登录相关问题："><span class="nav-number">3.2.1.</span> <span class="nav-text">关于登录相关问题：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mysql性能提升"><span class="nav-number">3.2.2.</span> <span class="nav-text">mysql性能提升</span></a></li></ol></li></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="tosang" src="https://cdn.jsdelivr.net/gh/uestc-toy/blog_file/img/avatar.png"><p class="site-author-name" itemprop="name">tosang</p><div class="site-description" itemprop="description">blog、记录和分享</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">13</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">7</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">10</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="sidebar-button motion-element"><a onclick='Chatra("openChat",!0)'><i class="fa fa-comment"></i> Chat</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Vlc3RjLXRveQ==" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;uestc-toy"><i class="fab fa-github fa-fw"></i>GitHub</span> </span><span class="links-of-author-item"><span class="exturl" data-url="bWFpbHRvOnRveW9rdXNhbmdAaG90bWFpbC5jb20=" title="E-Mail → mailto:toyokusang@hotmail.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</span></span></div><div class="cc-license motion-element" itemprop="license"><span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></span></div></div><div class="back-to-top motion-element"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2020</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">tosang</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-chart-area"></i> </span><span title="站点总字数">123k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="站点阅读时长">1:51</span></div><div class="powered-by">由 <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl theme-link" data-url="aHR0cHM6Ly90aGVtZS1uZXh0Lm9yZw==">NexT.Gemini</span> 强力驱动</div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/pjax/pjax.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script>var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});</script><script data-pjax>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/js/local-search.js"></script><script>!function(a,t,n){t.ChatraID="WeqmpGNhkLxAnnuqz";var c=a.createElement("script");t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},c.async=!1,c.src="https://call.chatra.io/chatra.js",a.head&&a.head.appendChild(c)}(document,window,"Chatra")</script><div id="pjax"><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div><script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1/needsharebutton.min.js"></script><script>pbOptions={iconStyle:"box",boxForm:"horizontal",position:"bottomCenter",networks:"Weibo,Wechat,Douban,QQZone"},new needShareButton("#needsharebutton-postbottom",pbOptions),flOptions={iconStyle:"box",boxForm:"horizontal",position:"middleRight",networks:"Weibo,Wechat,Douban,QQZone"},new needShareButton("#needsharebutton-float",flOptions)</script><script>NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = '昵称,邮箱,链接';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : true,
      notify     : false,
      appId      : 'cEWy5xlMxSYtWw1jc0vQSgr9-gzGzoHsz',
      appKey     : 'zR4PkPOIJ7DAgbKG7IoJDRS8',
      placeholder: "请发表你的评论",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});</script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7}});</script></body></html>